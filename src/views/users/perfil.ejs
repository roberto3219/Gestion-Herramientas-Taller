<!DOCTYPE html>
<html lang="es">
<%- include('../partials/head.ejs') %>
<body>
<%- include('../partials/header') %>
  <div class="container mt-4">
    <h2>Perfil del Usuario</h2>

    <!-- Foto de perfil -->
    <div class="text-center mb-3">
      <img src="<%= usuario.img_user ? '/img/users/' + usuario.img_user : '/img/default.png' %>" alt="Foto de perfil" class="rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">
    </div>
    <!-- Información -->
    <div class="card p-3">
      <p><strong>Nombre:</strong> <%= usuario.nombre %></p>
      <p><strong>Email:</strong> <%= usuario.email %></p>
      <p><strong>Rol:</strong> <%= usuario.role_id == 1 ? "Administrador" : "Usuario" %></p>
    </div>

    <!-- Botones -->
    <div class="mt-3" style="display: flex; gap: 10px;flex-wrap: wrap;justify-content: center;">
        <form action="/users/profile" method="post">
            <input type="submit" value="Cerrar Sesión" class="btn btn-danger">
        </form>
        <button class="btn btn-dark" id="btnTogglePassword">Cambiar Contraseña</button>
        <a  class="btn btn-info" href="#" id="btnEditarPerfil">Editar Perfil</a>
        <form action="/users/backup" method="get">
            <input type="submit" value="Copia de Seguridad(JSON)" class="btn btn-success">
        </form>
        


        <form id="restoreForm" action="/users/restore" method="post">
        <input type="hidden" name="mode" id="modeInput">
        <button type="button" class="btn btn-primary" onclick="openRestoreDialog()">
          Restaurar Copia de Seguridad (JSON)
        </button>
        </form>
        <!-- Ventanita de confirmación -->
      <!-- Modal de Bootstrap -->
<div class="modal fade" id="restoreModal" tabindex="-1" aria-labelledby="restoreModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="restoreModalLabel">Restaurar Copia de Seguridad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body text-center">
        <p><strong>¿Qué desea hacer con los datos existentes?</strong></p>
        <p class="text-muted">Puedes mantener los datos (Merge) o reemplazarlos completamente (Replace).</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" onclick="submitRestore('merge')">Mantener (Merge)</button>
        <button type="button" class="btn btn-danger" onclick="submitRestore('replace')">Eliminar (Replace)</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>






        <button class="btn btn-dark" id="btnGenerarPDF">Generar PDFs</button>
    </div>

    <!-- 🔹 Formulario oculto para cambiar contraseña -->
    <div id="formPassword" class="card p-3 mt-3" style="display:none; max-width: 500px; margin:auto;">
      <h5>Cambiar Contraseña</h5>
      <form class="form-change-pass" action="/users/change-password" method="post">
        <div class="mb-3">
          <% if (error != undefined) {%>
          <div class="alert alert-danger"><%= error %></div>
          <% } %>
          <div class="errores"></div>
            <label for="currentPassword" class="form-label">Contraseña actual</label>
          <input type="password" name="currentPassword" id="currentPassword" class="form-control currentPassword1" required>
        </div>
        <div class="mb-3">
          <label for="newPassword" class="form-label">Nueva contraseña</label>
          <input type="password" name="newPassword" id="newPassword" class="form-control newPassword1" required>
        </div>
        <div class="mb-3">
          <label for="confirmPassword" class="form-label">Confirmar nueva contraseña</label>
          <input type="password" name="confirmPassword" id="confirmPassword" class="form-control confirmPassword1" required>
        </div>
        <button type="submit" class="btn btn-primary">Guardar cambios</button>
      </form>
    </div>
    
    <div id="formEditarPerfil" style="display:none; margin-top:20px;">
      <form action="/users/edit" method="post" class="card p-3" enctype="multipart/form-data" style="max-width: 600px; margin:auto;">
        <h5>Editar Perfil</h5>
        <div class="mb-3">
          <label for="username" class="form-label">Nombre de usuario</label>
          <input type="text" class="form-control" id="username" name="username" value="<%= usuario.user_name %>" required>
        </div>
        <div class="mb-3">
          <label for="nombre" class="form-label">Nombre Completo</label>
          <input type="text" class="form-control" id="nombre" name="nombre" value="<%= usuario.nombre %>" required>
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Correo Electrónico</label>
          <input type="email" class="form-control" id="email" name="email" value="<%= usuario.email %>" required>
        </div>
        <div class="mb-3">
          <label for="imagen" class="form-label">Foto de Perfil</label>
          <input type="file" class="form-control" id="imagen" name="imagen" value="<%= usuario.img_usuario %>">          
        </div>
        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
      </form>
    </div>

  </div>
  <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/js/perfil.js"></script>
  <script src="/js/changePass.js"></script>
  <script src="/js/restore.js"></script>
</body>
</html>
